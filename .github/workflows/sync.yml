name: "åŒæ­¥ä¸Šæ¸¸ä»“åº“: chengege666/cesu"

on:
  # ğŸ•’ è§¦å‘å™¨ 1: å®šæ—¶è¿è¡Œ (æ¯å¤© UTC æ—¶é—´ 01:00 è¿è¡Œï¼Œç›¸å½“äºåŒ—äº¬æ—¶é—´ 09:00)
  schedule:
    - cron: '0 1 * * *'
  # âœ‹ è§¦å‘å™¨ 2: æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      branch:
        description: 'é€‰æ‹©è¦åŒæ­¥çš„ç›®æ ‡åˆ†æ”¯'
        required: true
        é»˜è®¤: 'main' # âš ï¸ è¯·æ ¹æ®æ‚¨ä»“åº“çš„é»˜è®¤åˆ†æ”¯åä¿®æ”¹æ­¤é¡¹

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: âœ… æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ GITHUB_TOKEN è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå¿…é¡»å…·æœ‰ 'contents: write' æƒé™æ‰èƒ½æ¨é€
          token: ${{ secrets.GITHUB_TOKEN }}
          # æ·±åº¦æ‹‰å–ï¼Œç¡®ä¿è·å–æ‰€æœ‰å†å²è®°å½•
          fetch-depth: 0
          # è·å–æ‰‹åŠ¨è¾“å…¥çš„åˆ†æ”¯åï¼Œå¦åˆ™ä½¿ç”¨ main åˆ†æ”¯
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: ğŸ–¥ï¸ é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ‘ğŸ» æ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶æ‰§è¡ŒåŒæ­¥
        run: |
          # å®šä¹‰ä¸Šæ¸¸ä»“åº“ URL
          UPSTREAM_REPO="https://github.com/chengege666/cesu.git"
          
          # è·å–å½“å‰åˆ†æ”¯å
          CURRENT_BRANCH=$(git branch --show-current)
          echo "å½“å‰åŒæ­¥åˆ†æ”¯: $CURRENT_BRANCH"

          # æ·»åŠ ä¸Šæ¸¸ remote (å¦‚æœå·²å­˜åœ¨ä¼šè·³è¿‡é”™è¯¯)
          echo "æ·»åŠ ä¸Šæ¸¸ remote: upstream"
          git remote add upstream $UPSTREAM_REPO || echo "Remote 'upstream' already exists."

          # ä»ä¸Šæ¸¸æ‹‰å–å†…å®¹
          echo "ä»ä¸Šæ¸¸æ‹‰å–æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾"
          git fetch upstream

          # æ¨èä½¿ç”¨ rebase ä¿æŒå†å²è®°å½•çº¿æ€§ï¼Œé¿å…ä¸å¿…è¦çš„ merge commit
          echo "æ‰§è¡Œ rebase æ“ä½œ: åˆå¹¶ä¸Šæ¸¸åˆ†æ”¯ upstream/$CURRENT_BRANCH"
          if git rebase upstream/$CURRENT_BRANCH; then
              echo "Rebase æˆåŠŸã€‚"
              # æ¨é€å˜æ›´åˆ°è‡ªå·±çš„ä»“åº“ (ä½¿ç”¨ --force-with-lease æ›´å®‰å…¨)
              echo "æ¨é€å˜æ›´åˆ° origin/$CURRENT_BRANCH"
              git push origin $CURRENT_BRANCH
              echo "æ¨é€æˆåŠŸã€‚"
          else
              echo "âš ï¸ Rebase å¤±è´¥ã€‚å¯èƒ½æ˜¯å­˜åœ¨å†²çªã€‚å·¥ä½œæµå°†ç»ˆæ­¢ã€‚"
              git rebase --abort # ç»ˆæ­¢ rebase
              exit 1 # ç»ˆæ­¢å·¥ä½œæµ
          fi
          
      - name: âœ… åŒæ­¥å·¥ä½œæµå®Œæˆ
        if: success()
        run: echo "åŒæ­¥ä¸Šæ¸¸ä»“åº“ chengege666/cesu åˆ°åˆ†æ”¯ ${{ github.event.inputs.branch || 'main' }} æˆåŠŸï¼"
      
      - name: ğŸ‘ğŸ» åŒæ­¥å·¥ä½œæµå¤±è´¥
        if: failure()
        run: echo "åŒæ­¥å¤±è´¥ã€‚è¯·æ£€æŸ¥æ—¥å¿—ï¼Œç‰¹åˆ«æ˜¯ rebase æ­¥éª¤ï¼Œå¯èƒ½å­˜åœ¨åˆå¹¶å†²çªéœ€è¦æ‰‹åŠ¨è§£å†³ã€‚"
